<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø£Ø³Ø¦Ù„Ø© ÙƒØ±ØªÙˆÙ†ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Changa:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Changa', sans-serif;
            background-color: #0d47a1; /* Deep Blue Background */
            color: white;
            overflow: hidden;
        }
        .cartoon-button {
            background-color: #ffc107; /* Amber/Yellow */
            color: #212121; /* Dark Gray Text */
            border: 4px solid black;
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: 700;
            font-size: 1.2rem;
            text-align: center;
            cursor: pointer;
            transform: rotate(-2deg);
            transition: all 0.2s ease-in-out;
            box-shadow: 5px 5px 0px rgba(0,0,0,0.4);
            position: relative;
        }
        .cartoon-button:hover {
            transform: rotate(0deg) scale(1.05);
            box-shadow: 8px 8px 0px rgba(0,0,0,0.4);
        }
        .cartoon-button:active {
            transform: rotate(0deg) scale(1.0) translateY(2px);
            box-shadow: 2px 2px 0px rgba(0,0,0,0.4);
        }
        .category-button {
            background-color: #1976d2; /* Lighter Blue */
            border: 3px solid black;
            border-radius: 10px;
            padding: 15px;
            transform: rotate(-1.5deg);
            width: 100%;
        }
        .category-button:hover {
             transform: rotate(0deg) scale(1.03);
        }
        .category-button.locked {
            background-color: #424242;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .character-card {
            border: 4px solid black;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .character-card.selected {
            border-color: #ffc107;
            transform: scale(1.1);
            box-shadow: 0 0 20px #ffc107;
        }
        .screen {
            display: none;
            width: 100%;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            overflow-y: auto;
            padding: 20px;
        }
        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #qrcode {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .player-avatar {
            width: 60px;
            height: 60px;
            background-color: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 3px solid black;
        }
        .answer-option {
             background-color: #1976d2;
             border: 3px solid black;
             border-radius: 10px;
             padding: 15px;
             transform: rotate(-1.5deg);
             width: 80%;
             margin-bottom: 15px;
        }
         .answer-option:hover {
             transform: rotate(0deg) scale(1.03);
        }

    </style>
</head>
<body class="bg-blue-900">

    <!-- Screen: Start -->
    <div id="start-screen" class="screen active">
        <div class="w-full max-w-md text-center">
            <h1 class="text-5xl font-bold mb-4 text-yellow-400">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h1>
            <p class="text-xl mb-8">Ø§Ø®ØªØ± Ø´Ø®ØµÙŠØªÙƒ ÙˆØ£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ</p>
            
            <div class="mb-6">
                <input type="text" id="player-name-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" class="w-full p-3 rounded-lg text-black text-center text-xl">
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
                <div class="character-card bg-pink-400 p-2" data-char="ğŸ¦™">
                    <div class="player-avatar">ğŸ¦™</div>
                </div>
                <div class="character-card bg-green-400 p-2" data-char="ğŸ‘">
                    <div class="player-avatar">ğŸ‘</div>
                </div>
                <div class="character-card bg-red-400 p-2" data-char="ğŸ‘¾">
                    <div class="player-avatar">ğŸ‘¾</div>
                </div>
                <div class="character-card bg-blue-400 p-2" data-char="ğŸ¤–">
                    <div class="player-avatar">ğŸ¤–</div>
                </div>
            </div>

            <button id="create-room-btn" class="cartoon-button w-full mb-4">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button id="join-room-btn" class="cartoon-button w-full bg-green-500">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© (Ù„Ùˆ Ù…Ø¹Ùƒ Ø±Ø§Ø¨Ø·)</button>
        </div>
    </div>

    <!-- Screen: Lobby -->
    <div id="lobby-screen" class="screen">
        <div class="w-full max-w-2xl text-center">
            <h2 class="text-4xl font-bold mb-4">ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h2>
            <p class="mb-2">Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø¯Ø¹ÙˆØ© Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ!</p>
            <p class="mb-4 text-yellow-300">Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©: <span id="room-id-display"></span></p>
            
            <div class="flex justify-center">
                <div id="qrcode"></div>
            </div>
            
            <p class="mt-4 mb-2">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† ÙÙŠ Ø§Ù„ØºØ±ÙØ© (<span id="player-count">1</span>/10):</p>
            <div id="players-list" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                <!-- Player cards will be injected here -->
            </div>
            
            <button id="start-game-btn" class="cartoon-button w-full max-w-xs">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©!</button>
            <p class="text-sm mt-2 text-gray-300">ÙÙ‚Ø· Ù…Ù†Ø´Ø¦ Ø§Ù„ØºØ±ÙØ© ÙŠÙ…ÙƒÙ†Ù‡ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.</p>
             <p class="text-xs mt-4">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ: <span id="user-id-display" class="text-yellow-200"></span></p>
        </div>
    </div>

    <!-- Screen: Category Selection -->
    <div id="category-screen" class="screen">
        <div class="w-full max-w-4xl text-center">
            <h2 class="text-4xl font-bold mb-6">Ø§Ø®ØªØ± ÙØ¦Ø© Ù„Ù„Ø³Ø¤Ø§Ù„</h2>
            <div id="categories-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <!-- Categories will be injected here -->
            </div>
        </div>
    </div>

    <!-- Screen: Question -->
    <div id="question-screen" class="screen">
        <div class="w-full max-w-2xl text-center flex flex-col items-center">
            <div class="w-full flex justify-between items-center mb-4">
                <span id="question-timer" class="text-3xl font-bold text-yellow-400">30</span>
                <h3 class="text-2xl font-bold">Ø§Ù„Ø¬ÙˆÙ„Ø© <span id="round-counter">1</span>/10</h3>
            </div>
            <div class="bg-blue-800 p-6 rounded-lg border-4 border-black mb-6 w-full">
                <p class="text-xl mb-4 font-bold" id="question-category"></p>
                <p class="text-2xl min-h-[60px]" id="question-text"></p>
                <img id="question-image" src="" class="max-w-full max-h-64 mx-auto rounded-lg mt-4 hidden">
            </div>
            <div id="answer-options" class="w-full flex flex-col items-center">
                <!-- Answer options or input field will be here -->
            </div>
        </div>
    </div>

    <!-- Screen: End Game -->
    <div id="end-game-screen" class="screen">
        <div class="w-full max-w-md text-center">
            <h1 class="text-5xl font-bold mb-6 text-yellow-400">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h1>
            <div id="final-scores" class="space-y-3">
                <!-- Final scores will be listed here -->
            </div>
            <button id="play-again-btn" class="cartoon-button w-full mt-8">Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Your web app's Firebase configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBQLIKtueG954OYiWz-YDBl_LyUxc_VRT8",
            authDomain: "el-klika.firebaseapp.com",
            projectId: "el-klika",
            storageBucket: "el-klika.appspot.com",
            messagingSenderId: "357776786294",
            appId: "1:357776786294:web:8cb4ec7eabe2895a133057",
            measurementId: "G-0VZ35M4V50"
        };
        
        // --- App State ---
        let app, auth, db;
        let userId, currentRoomId, player, roomUnsubscribe;
        let timerInterval;

        // --- UI Elements ---
        const screens = document.querySelectorAll('.screen');
        const startScreen = document.getElementById('start-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const categoryScreen = document.getElementById('category-screen');
        const questionScreen = document.getElementById('question-screen');
        const endGameScreen = document.getElementById('end-game-screen');
        
        const playerNameInput = document.getElementById('player-name-input');
        const characterCards = document.querySelectorAll('.character-card');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const playAgainBtn = document.getElementById('play-again-btn');

        // --- Question Data ---
        const questions = {
            'Ø£Ù†Ù…ÙŠ ÙˆÙƒØ±ØªÙˆÙ†': [
                { q: 'Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù‚Ø±Ø¯ Ø§Ù„Ø°ÙŠ ÙŠØ±Ø§ÙÙ‚ Ø¹Ù„Ø§Ø¡ Ø§Ù„Ø¯ÙŠÙ†ØŸ', a: ['Ø£Ø¨Ùˆ', 'Ø²Ø¹ÙØ±Ø§Ù†', 'Ø±Ø§Ø¬Ø§', 'ÙŠØ§Ø³Ù…ÙŠÙ†'], correct: 0 },
                { q: 'ÙÙŠ Ø£ÙŠ Ø£Ù†Ù…ÙŠ ØªØ¬Ø¯ Ø´Ø®ØµÙŠØ© "Ø³Ø§Ø³ÙƒÙŠ Ø£ÙˆØªØ´ÙŠÙ‡Ø§"ØŸ', a: ['Ù†Ø§Ø±ÙˆØªÙˆ', 'ÙˆÙ† Ø¨ÙŠØ³', 'Ø¨Ù„ÙŠØªØ´', 'Ø¯Ø±Ø§ØºÙˆÙ† Ø¨ÙˆÙ„'], correct: 0 },
                { q: 'Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆÙƒÙŠÙ…ÙˆÙ† Ø§Ù„Ø£ØµÙØ± Ø§Ù„Ø´Ù‡ÙŠØ± Ø±ÙÙŠÙ‚ Ø¢Ø´ØŸ', a: ['Ø¨ÙŠÙƒØ§ØªØ´Ùˆ', 'ØªØ´Ø§Ø±Ù…Ù†Ø¯Ø±', 'Ø¨Ù„Ø¨Ø§Ø³ÙˆØ±', 'Ø³ÙƒÙˆÙŠØ±ØªÙ„'], correct: 0 },
            ],
            'Ø£ÙÙ„Ø§Ù… ÙˆÙ…Ø³Ù„Ø³Ù„Ø§Øª': [
                { q: 'Ù…Ù† Ù‡Ùˆ Ø§Ù„Ù…Ù…Ø«Ù„ Ø§Ù„Ø°ÙŠ Ù‚Ø§Ù… Ø¨Ø¯ÙˆØ± "Ø§Ù„Ø¬ÙˆÙƒØ±" ÙÙŠ ÙÙŠÙ„Ù… The Dark KnightØŸ', a: ['Ù‡ÙŠØ« Ù„ÙŠØ¯Ø¬Ø±', 'Ø¬Ø§Ùƒ Ù†ÙŠÙƒÙ„Ø³ÙˆÙ†', 'Ø®ÙˆØ§ÙƒÙŠÙ† ÙÙŠÙ†ÙŠÙƒØ³', 'Ø¬Ø§Ø±ÙŠØ¯ Ù„ÙŠØªÙˆ'], correct: 0 },
                { q: 'Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ù„Ø³Ù„ Ø§Ù„Ø°ÙŠ ØªØ¯ÙˆØ± Ø£Ø­Ø¯Ø§Ø«Ù‡ ÙÙŠ "ÙˆÙŠØ³ØªØ±ÙˆØ³"ØŸ', a: ['ØµØ±Ø§Ø¹ Ø§Ù„Ø¹Ø±ÙˆØ´', 'ÙØ§ÙŠÙƒÙ†Ø¬Ø²', 'Ø¨Ø±ÙŠÙƒÙ†Ø¬ Ø¨Ø§Ø¯', 'Ø°Ø§ ÙˆÙŠØªØ´Ø±'], correct: 0 },
            ],
            'Ø¬ØºØ±Ø§ÙÙŠØ§': [
                { q: 'Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø£Ø³ØªØ±Ø§Ù„ÙŠØ§ØŸ', a: ['ÙƒØ§Ù†Ø¨Ø±Ø§', 'Ø³ÙŠØ¯Ù†ÙŠ', 'Ù…Ù„Ø¨ÙˆØ±Ù†', 'Ø¨ÙŠØ±Ø«'], correct: 0 },
                { q: 'ÙÙŠ Ø£ÙŠ Ù‚Ø§Ø±Ø© ØªÙ‚Ø¹ Ø¯ÙˆÙ„Ø© Ù…ØµØ±ØŸ', a: ['Ø£ÙØ±ÙŠÙ‚ÙŠØ§', 'Ø¢Ø³ÙŠØ§', 'Ø£ÙˆØ±ÙˆØ¨Ø§', 'ÙƒÙ„Ø§Ù‡Ù…Ø§ (Ø£ÙØ±ÙŠÙ‚ÙŠØ§ ÙˆØ¢Ø³ÙŠØ§)'], correct: 3 },
                { q: 'Ù…Ø§ Ù‡Ùˆ Ø£Ø·ÙˆÙ„ Ù†Ù‡Ø± ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ', a: ['Ù†Ù‡Ø± Ø§Ù„Ù†ÙŠÙ„', 'Ù†Ù‡Ø± Ø§Ù„Ø£Ù…Ø§Ø²ÙˆÙ†', 'Ù†Ù‡Ø± Ø§Ù„ÙŠØ§Ù†ØºØªØ³ÙŠ', 'Ù†Ù‡Ø± Ø§Ù„Ù…Ø³ÙŠØ³ÙŠØ¨ÙŠ'], correct: 0 },
            ],
            'Ø¹Ù„ÙˆÙ…': [
                 { q: 'Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠ Ù„Ù„Ù…Ø§Ø¡ØŸ', a: ['H2O', 'CO2', 'O2', 'NaCl'], correct: 0 },
                 { q: 'ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙˆØ§ÙƒØ¨ ÙÙŠ Ù†Ø¸Ø§Ù…Ù†Ø§ Ø§Ù„Ø´Ù…Ø³ÙŠØŸ', a: ['8', '9', '7', '10'], correct: 0 },
            ],
            'Ø±ÙŠØ§Ø¶Ø©': [
                { q: 'ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ ÙØ±ÙŠÙ‚ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù…ØŸ', a: ['11', '9', '7', '5'], correct: 0 },
                { q: 'Ù…Ù† Ù‡Ùˆ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ ÙŠÙÙ„Ù‚Ø¨ Ø¨Ù€ "Ø§Ù„Ø¯ÙˆÙ†"ØŸ', a: ['ÙƒØ±ÙŠØ³ØªÙŠØ§Ù†Ùˆ Ø±ÙˆÙ†Ø§Ù„Ø¯Ùˆ', 'Ù„ÙŠÙˆÙ†ÙŠÙ„ Ù…ÙŠØ³ÙŠ', 'Ù†ÙŠÙ…Ø§Ø±', 'Ù…Ø­Ù…Ø¯ ØµÙ„Ø§Ø­'], correct: 0 },
            ],
             'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©': [
                { q: 'Ù…Ø§ Ù‡Ùˆ Ø£ÙƒØ¨Ø± Ø­ÙŠÙˆØ§Ù† Ø¹Ù„Ù‰ ÙˆØ¬Ù‡ Ø§Ù„Ø£Ø±Ø¶ØŸ', a: ['Ø§Ù„Ø­ÙˆØª Ø§Ù„Ø£Ø²Ø±Ù‚', 'Ø§Ù„ÙÙŠÙ„ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ', 'Ø§Ù„Ø²Ø±Ø§ÙØ©', 'Ø§Ù„Ù‚Ø±Ø´ Ø§Ù„Ø£Ø¨ÙŠØ¶'], correct: 0 },
                { q: 'ÙÙŠ Ø£ÙŠ Ø¨Ù„Ø¯ ØªÙ… Ø§Ø®ØªØ±Ø§Ø¹ Ø§Ù„Ø¨ÙŠØªØ²Ø§ØŸ', a: ['Ø¥ÙŠØ·Ø§Ù„ÙŠØ§', 'Ø£Ù…Ø±ÙŠÙƒØ§', 'Ø§Ù„ØµÙŠÙ†', 'Ø§Ù„ÙŠÙˆÙ†Ø§Ù†'], correct: 0 },
            ]
        };

        // --- Functions ---
        
        function initialize() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const roomIdFromUrl = urlParams.get('room');

                    if (roomIdFromUrl) {
                        currentRoomId = roomIdFromUrl;
                        if(validatePlayerInfo(true)) { // validate silently
                           await joinRoom(true);
                        }
                    }
                } else {
                    await signInAnonymously(auth);
                }
            });
        }

        function switchScreen(screenId) {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function selectCharacter(e) {
            characterCards.forEach(card => card.classList.remove('selected'));
            e.currentTarget.classList.add('selected');
        }

        async function handleCreateRoom() {
            if (!validatePlayerInfo()) return;
            currentRoomId = generateRoomId();
            
            const newRoom = {
                hostId: userId,
                players: [player],
                gameState: 'waiting', // waiting, selecting, inRound, finished
                currentRound: 0,
                createdAt: new Date(),
            };

            const roomsCollection = collection(db, "rooms");
            await setDoc(doc(roomsCollection, currentRoomId), newRoom);
            subscribeToRoom(currentRoomId);
            switchScreen('lobby-screen');
        }
        
        async function joinRoom(fromUrl = false) {
             if(!fromUrl) {
                if (!validatePlayerInfo()) return;
                const roomIdInput = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©:");
                if (!roomIdInput) return;
                currentRoomId = roomIdInput.trim();
             }

            const roomRef = doc(db, "rooms", currentRoomId);
            const roomSnap = await getDoc(roomRef);

            if (roomSnap.exists()) {
                 const roomData = roomSnap.data();
                if (roomData.players.length >= 10) {
                    alert("Ø¹Ø°Ø±Ø§Ù‹, Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©.");
                    return;
                }
                // Prevent adding the same user twice
                if (!roomData.players.some(p => p.userId === userId)) {
                    await updateDoc(roomRef, {
                        players: arrayUnion(player)
                    });
                }
                subscribeToRoom(currentRoomId);
                switchScreen('lobby-screen');
            } else {
                alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØºØ±ÙØ©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù.");
                if(fromUrl) {
                    window.history.replaceState({}, document.title, window.location.pathname); // Clear invalid room from URL
                }
            }
        }
        
        function validatePlayerInfo(silent = false) {
            const name = playerNameInput.value.trim();
            const characterEl = document.querySelector('.character-card.selected');
            if (!name || !characterEl) {
                if (!silent) alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø´Ø®ØµÙŠØ©!');
                return false;
            }
            player = {
                userId: userId,
                name: name,
                character: characterEl.dataset.char,
                score: 0,
                hasAnswered: false
            };
            return true;
        }

        function subscribeToRoom(roomId) {
            if (roomUnsubscribe) roomUnsubscribe();
            
            const roomRef = doc(db, "rooms", roomId);
            roomUnsubscribe = onSnapshot(roomRef, (doc) => {
                if (!doc.exists()) {
                    if (timerInterval) clearInterval(timerInterval);
                    alert("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©.");
                    window.location.reload();
                    return;
                }
                const roomData = doc.data();
                updateLobbyUI(roomData);
                updateGameState(roomData);
            });
        }
        
        function updateLobbyUI(roomData) {
            document.getElementById('room-id-display').textContent = currentRoomId;
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';
            roomData.players.forEach(p => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex flex-col items-center p-2 rounded-lg bg-blue-800';
                playerDiv.innerHTML = `
                    <div class="player-avatar" style="background-color: ${p.userId === roomData.hostId ? '#ffeb3b' : '#e0e0e0'}">${p.character}</div>
                    <p class="mt-2 font-semibold">${p.name}</p>
                    <p class="text-sm text-yellow-300">Score: ${p.score}</p>
                `;
                playersList.appendChild(playerDiv);
            });
            document.getElementById('player-count').textContent = roomData.players.length;
            
            // Show start button only to host
            startGameBtn.style.display = roomData.hostId === userId ? 'block' : 'none';

            // Generate QR Code
            const qrCodeElement = document.getElementById('qrcode');
            qrCodeElement.innerHTML = "";
            const roomUrl = `${window.location.origin}${window.location.pathname}?room=${currentRoomId}`;
            new QRCode(qrCodeElement, {
                text: roomUrl,
                width: 128,
                height: 128,
            });
        }

        function updateGameState(roomData) {
            // If we are on the start screen but a room ID exists in the URL,
            // and we haven't successfully joined yet, don't change the screen.
            const urlParams = new URLSearchParams(window.location.search);
            if (startScreen.classList.contains('active') && urlParams.get('room')) {
                return;
            }
            
            switch(roomData.gameState) {
                case 'waiting':
                    switchScreen('lobby-screen');
                    break;
                case 'selecting':
                    switchScreen('category-screen');
                    renderCategories(roomData);
                    break;
                case 'inRound':
                    switchScreen('question-screen');
                    renderQuestion(roomData);
                    break;
                case 'finished':
                    if (timerInterval) clearInterval(timerInterval);
                    switchScreen('end-game-screen');
                    renderFinalScores(roomData);
                    break;
            }
        }
        
        async function handleStartGame() {
            const roomRef = doc(db, "rooms", currentRoomId);
            const roomSnap = await getDoc(roomRef);
            if(roomSnap.data().players.length < 1) { // Or 2 if you want minimum 2 players
                alert("ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.");
                return;
            }
            await updateDoc(roomRef, {
                gameState: 'selecting',
                currentRound: 1
            });
        }

        function renderCategories(roomData) {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = '';
            Object.keys(questions).forEach(cat => {
                const button = document.createElement('button');
                button.className = 'cartoon-button category-button';
                button.textContent = cat;
                button.onclick = () => selectCategory(cat);
                grid.appendChild(button);
            });
        }

        async function selectCategory(category) {
            const categoryQuestions = questions[category];
            const questionIndex = Math.floor(Math.random() * categoryQuestions.length);
            
            const roomRef = doc(db, "rooms", currentRoomId);
            const roomSnap = await getDoc(roomRef);
            const currentPlayers = roomSnap.data().players;

            await updateDoc(roomRef, {
                gameState: 'inRound',
                currentQuestion: {
                    category: category,
                    index: questionIndex,
                },
                'players': currentPlayers.map(p => ({...p, hasAnswered: false }))
            });
        }
        
        function renderQuestion(roomData) {
            if (!roomData.currentQuestion) return;

            const { category, index } = roomData.currentQuestion;
            const questionData = questions[category][index];

            document.getElementById('round-counter').textContent = roomData.currentRound;
            document.getElementById('question-category').textContent = category;
            document.getElementById('question-text').textContent = questionData.q;
            
            const imgEl = document.getElementById('question-image');
            if (questionData.img) {
                imgEl.src = questionData.img;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }

            const answersContainer = document.getElementById('answer-options');
            answersContainer.innerHTML = '';

            const currentPlayer = roomData.players.find(p => p.userId === userId);
            if (currentPlayer && currentPlayer.hasAnswered) {
                answersContainer.innerHTML = '<p class="text-2xl text-yellow-300">Ù„Ù‚Ø¯ Ø£Ø¬Ø¨Øª. Ø§Ù†ØªØ¸Ø± Ø¨Ù‚ÙŠØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</p>';
                return; // Don't start a new timer if already answered
            }

            questionData.a.forEach((answer, i) => {
                const button = document.createElement('button');
                button.className = 'cartoon-button answer-option';
                button.textContent = answer;
                button.onclick = () => submitAnswer(i, questionData.correct);
                answersContainer.appendChild(button);
            });
            
            startQuestionTimer(roomData);
        }

        function startQuestionTimer(roomData) {
            if (timerInterval) clearInterval(timerInterval);
            let timeLeft = 30;
            const timerEl = document.getElementById('question-timer');
            timerEl.textContent = timeLeft;

            timerInterval = setInterval(async () => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    // Only host moves to next round to avoid race conditions
                    if (userId === roomData.hostId) {
                        await endRound();
                    }
                }
            }, 1000);
        }

        async function submitAnswer(selectedIndex, correctIndex) {
            if (timerInterval) clearInterval(timerInterval);
            const isCorrect = selectedIndex === correctIndex;
            const scoreToAdd = isCorrect ? 10 : 0;

            const roomRef = doc(db, "rooms", currentRoomId);
            const roomSnap = await getDoc(roomRef);
            const roomData = roomSnap.data();
            
            const updatedPlayers = roomData.players.map(p => {
                if (p.userId === userId && !p.hasAnswered) { // Ensure score is added only once
                    return { ...p, score: p.score + scoreToAdd, hasAnswered: true };
                }
                return p;
            });

            await updateDoc(roomRef, { players: updatedPlayers });

            // Check if all players have answered
            const allAnswered = updatedPlayers.every(p => p.hasAnswered);
            if (allAnswered && userId === roomData.hostId) {
                await endRound();
            }
        }
        
        async function endRound() {
            if (timerInterval) clearInterval(timerInterval);
            
            const roomRef = doc(db, "rooms", currentRoomId);
            const roomSnap = await getDoc(roomRef);
            const roomData = roomSnap.data();

            if (roomData.currentRound >= 10) {
                // Game over
                await updateDoc(roomRef, { gameState: 'finished' });
            } else {
                // Next round
                await updateDoc(roomRef, {
                    gameState: 'selecting',
                    currentRound: roomData.currentRound + 1
                });
            }
        }
        
        function renderFinalScores(roomData) {
            const scoresContainer = document.getElementById('final-scores');
            scoresContainer.innerHTML = '';
            const sortedPlayers = [...roomData.players].sort((a, b) => b.score - a.score);
            
            sortedPlayers.forEach((p, index) => {
                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'flex justify-between items-center p-3 bg-blue-800 rounded-lg text-xl';
                scoreDiv.innerHTML = `
                    <span>${index + 1}. ${p.name} ${p.character}</span>
                    <span class="font-bold text-yellow-400">${p.score}</span>
                `;
                scoresContainer.appendChild(scoreDiv);
            });
        }
        
        function handlePlayAgain() {
            if (roomUnsubscribe) roomUnsubscribe();
            window.location.search = ''; // Resets the URL to not auto-join
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // --- Event Listeners ---
        characterCards.forEach(card => card.addEventListener('click', selectCharacter));
        createRoomBtn.addEventListener('click', handleCreateRoom);
        joinRoomBtn.addEventListener('click', () => joinRoom(false));
        startGameBtn.addEventListener('click', handleStartGame);
        playAgainBtn.addEventListener('click', handlePlayAgain);

        // --- Initialize App ---
        window.onload = initialize;

    </script>
</body>
</html>